<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:faces="jakarta.faces"
      xmlns:ui="jakarta.faces.facelets"
      xmlns:f="jakarta.faces.core"
      xmlns:h="jakarta.faces.html"
      xmlns:pt="jakarta.faces.passthrough"
      xmlns:cc="jakarta.faces.composite"
      xmlns:c="jakarta.tags.core"
      xmlns:p="primefaces"
      xmlns:fn="jakarta.tags.functions">
<h:head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <meta name="apple-mobile-web-app-capable" content="yes"/>
    <title>View Medical Records</title>
    <h:outputStylesheet library="webjars" name="primeflex/3.3.1/primeflex.min.css"/>
    <h:outputStylesheet library="assets" name="css/layout.css"/>
</h:head>
<h:body>

<h:form>
    <h1>Medical Records List</h1>
    <p:dataTable var="record" value="#{recordsBean.records}" id="recordsTable" paginator="true" rows="5">
        <p:column headerText="ID">
            <h:outputText value="#{record.id}"/>
        </p:column>
        <p:column headerText="Name">
            <h:outputText value="#{record.name}"/>
        </p:column>
        <p:column headerText="Age">
            <h:outputText value="#{record.age}"/>
        </p:column>
        <p:column headerText="Medical History">
            <h:outputText value="#{record.medicalHistory}"/>
        </p:column>
        <p:column>
            <p:commandButton value="Delete" action="#{recordsBean.deleteRecord(record.id)}" update="recordsTable"/>
        </p:column>
    </p:dataTable>
</h:form>

<script>
    // Use JavaScript to fetch records via REST API
    fetch('http://localhost:8080/api/records')  // Replace with your actual REST endpoint
        .then(response => response.json())
        .then(data => {
            // Populate records in JSF managed bean
            // This is just a mock, in real life you would bind it to a bean
            let recordsTable = document.querySelector("#recordsTable tbody");
            data.forEach(record => {
                let row = recordsTable.insertRow();
                row.innerHTML = `
                    <td>${record.id}</td>
                    <td>${record.name}</td>
                    <td>${record.age}</td>
                    <td>${record.medicalHistory}</td>
                    <td><button onclick="deleteRecord(${record.id})">Delete</button></td>
                `;
            });
        });
		
		// Function to handle record deletion via API
		function deleteRecord(recordId, button) {
			// Confirm before deletion
			if (confirm("Are you sure you want to delete this record?")) {
				// Send DELETE request to API
				fetch(`http://localhost:8080/api/records/${recordId}`, {
					method: 'DELETE',
				})
				.then(response => {
					if (response.ok) {
						// On success, remove the row from the table
						const row = button.closest("tr");
						row.remove();
						alert('Record deleted successfully.');
					} else {
						alert('Failed to delete record.');
					}
				})
				.catch(error => {
					alert('Error deleting record: ' + error);
				});
			}
		}
</script>

</h:body>
</html>
